## DAGs Airflow

af_load_to_staging.py - DAG Airflow для загрузки данных в Staging.
af_load_to_datawarehouse.py - DAG Airflow для загрузки и трансформации данных из Staging в DWH.

Каждый DAG Airflow может работать в режиме первичной загрузки и трансформации данных либо в режиме загрузки обновленных данных. Для этого DAG должен быть вызван с параметром, в котором задается мод: CREATE (первичная загрузка данных) или UPDATE (загрузка обновленных данных). 

Код для преобразования из Staging в Data Warehouse лежат в директории dwh_common.
Код для загрузки в Staging лежат в директории stg_common.

## Описание Staging и Staging Delta таблиц

В режиме CREATE данные загружатся в таблицы Staging:
akrasnova_staging.nobel_laureates
akrasnova_staging.countries_of_the_world
akrasnova_staging.cities
akrasnova_staging.country_continents
akrasnova_staging.country_currencies
akrasnova_staging.country_iso3
akrasnova_staging.country_names
akrasnova_staging.country_phones
akrasnova_staging.country_capital

В режиме CREATE создаются таблицы в Data Warehouse с данными из всех этих датасетов.

Предполагается, что регулярно будут приходить новые данные в следующие 3 таблицы Staging:
City - приходит полный список городов, не дельта, ежеквартально
Country - приходит полный список стран, не дельта, ежеквартально
Nobel Prizes - приходит дельта значений еженедельно - факты вручения Нобелевской Премии

Для 3 данных таблиц Staging, информация в которых будет обновляться (т.е. дополняться новыми partitions), создаются delta таблицы, в которых сохраняются новые партиции данных:
akrasnova_tmp.countries_delta
akrasnova_tmp.cities_delta
akrasnova_tmp.nobel_laureates_delta

Процесс загрузки данных в Staging и Staging Delta таблицы для Countries, Cities и Nobel Prizes таблиц не будет отличаться в режимах CREATE и UPDATE.

Данные будут накапливаются в этих delta таблицах с колонкой upd_date - датой сохранения данных в таблице, чтобы затем их можно было загрузить в DWH.
Последний оператор в графе DWH - это удаление delta таблиц, чтобы они могли быть созданы заново при поступлении следующей порции данных в Staging.

## Описание Data Warehouse таблиц

Обновленные данные City и Country датасетов будут сохраняться в DWH таблице в новых партициях, т.е. данные 2 таблиц становятся history таблицами:

akrasnova_wrh.cities - информация о городах
akrasnova_wrh.countries - информация о странах

Для более удобной обработки данных в режиме UPDATE в графе DWH создаются 2 дополнительные up-to-date таблицы:
akrasnova_wrh.countries_uptodate - для каждой страны остается только строка, загруженная последней, т. е. с максимальным значением upd_date
akrasnova_wrh.cities_uptodate - для каждого города остается только строка, загруженная последней, т. е. с максимальным значением upd_date

При обновлении данных (в режиме UPDATE) Nobel Laureates, т.к. поступает дельта с новыми значениями, в некоторых DWH таблицах для каждого логического ключа также будет сохранена строка, загруженная последней. Вот эти таблицы с агрегацией данных:

akrasnova_wrh.laureate_persons - для каждого лауреата-человека остается только строка, загруженная последней, т. е. с максимальным значением upd_date
akrasnova_wrh.organizations - для каждой организации остается только строка, загруженная последней, т. е. с максимальным значением upd_date
akrasnova_wrh.prize_types - для каждого типа Премий остается только строка, загруженная последней, т. е. с максимальным значением upd_date
akrasnova_wrh.societies - для каждого лауреата-сообщества остается только строка, загруженная последней, т. е. с максимальным значением upd_date
akrasnova_wrh.persons_in_orgs - для каждой пары laureate_id+org_name остается только строка, загруженная последней, т. е. с максимальным значением upd_date

Таблицы, созданные из Nobel Prizes датасета, без агрегации данных:

akrasnova_wrh.nobel_prizes 
	- данная таблица загружается как 1-to-1 из Staging Delta таблицы с данными по фактам вручения Нобелевской Премии, т.е. все поступающие значения должны быть новыми. В данной работе не будем проводить дополнительную проверку на дубликаты к существующим значениям. В таблице nobel_prizes все новые значения загружаются, и дальше таблица не преобразовывается.
akrasnova_wrh.dataset 
	- это по факту расширенная таблица nobel_prizes с дополнительной инфомацией о дауреатах, их организациях, странах, городах. В таблиц также просто загружаются новые значения, и таблица дальше не агрегируется.
akrasnova_wrh.codes_in_countries
	- таблица содержит связь между Country Code Id и Country Id. При каждой трансформации вычисляются новый Country Id и все данные в таблице перезаписываются.
